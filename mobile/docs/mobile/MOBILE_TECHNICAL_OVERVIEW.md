# Alca Hub Mobile Technical Overview

This guide gives new engineers a structured view of how the Android and iOS apps are assembled, configured, and deployed inside the Alca Hub repository. It complements the detailed step-by-step runbooks already located under `docs/mobile/android` and `docs/mobile/ios`.

## 1. Architecture at a glance
- Web UI: React 19 + Vite (sources in `frontend/src`). Capacitor wraps the built web assets under `frontend/dist`.
- Bridge: Capacitor 7.4.3 with Cordova compatibility enabled for legacy plugins.
- Native containers: `frontend/android` (Gradle, Kotlin) and `frontend/ios` (Xcode workspace, CocoaPods).
- Shared plugin helpers live in `frontend/src/utils/cordova-plugins.js`, with a ready-made validation screen at `/debug/camera` (`CameraTest.jsx`).

## 2. Repository layout (mobile-centric)
- `frontend/capacitor.config.json` – global Capacitor settings (app id, name, plugins).
- `frontend/android/` – Android project scaffold generated by Capacitor.
  - `app/src/main/AndroidManifest.xml` – permissions and intent queries for Cordova plugins.
  - `app/build.gradle` – application module (Kotlin target, dependencies).
  - `variables.gradle` – central version catalog (compileSdk 35, minSdk 23).
  - `app/src/main/java/com/alca/hub/MainActivity.kt` – Capacitor bridge activity.
- `frontend/ios/App/` – iOS workspace (`App.xcworkspace`, `Podfile`, `App/App` sources).
  - `App/App/Info.plist` – permission prompts and ATS rules.
  - `Podfile` – CocoaPods dependencies (`Capacitor`, `CapacitorCordova`, `CordovaPlugins`).
- `frontend/src/components/CameraTest.jsx` – in-app manual test for camera and GPS.
- `.vscode/` – recommended Cursor tasks for sync/build/debug automation.

## 3. Toolchain requirements
| Component | Minimum | Recommended notes |
|-----------|---------|-------------------|
| Node.js   | 18.x    | Project tested with npm 10 and pnpm/yarn disabled. |
| Java      | Temurin 21 | Export `JAVA_HOME` to `$(/usr/libexec/java_home -v 21)` for Gradle. |
| Android SDK | API 35 | Install via Android Studio (Command-line Tools + Platform Tools). |
| Xcode     | 15.x+   | Current environment runs Xcode 26 (build 17A400). Required for `xcodebuild`. |
| CocoaPods | 1.16.x | Ensure terminal locale is UTF-8 (`export LANG=en_US.UTF-8`). |

Additional environment variables:
```bash
# ~/.zshrc or equivalent
export JAVA_HOME=$(/usr/libexec/java_home -v 21)
export ANDROID_HOME="$HOME/Library/Android/sdk"
export PATH="$ANDROID_HOME/platform-tools:$ANDROID_HOME/cmdline-tools/latest/bin:$PATH"
export LANG=en_US.UTF-8
```

## 4. First-time setup workflow
1. Install dependencies (`npm install`) inside `frontend/`.
2. Build web assets before any sync: `npm run build`.
3. Run `npx cap doctor` to verify Capacitor, Android, and iOS status.
4. Sync platforms:
   - `npx cap sync android`
   - `LANG=en_US.UTF-8 npx cap sync ios` (UTF-8 avoids CocoaPods normalization errors).
5. Install CocoaPods dependencies if not already cached:
   ```bash
   cd frontend/ios/App
   pod install
   ```

## 5. Android playbook
### Build and run
```bash
cd frontend
JAVA_HOME=$(/usr/libexec/java_home -v 21) npx cap run android
# or open in Android Studio
npx cap open android
```
- Debug APK: `frontend/android/app/build/outputs/apk/debug/app-debug.apk`.
- Gradle plugin versions: Android Gradle 8.13.0, Kotlin compiler 1.9.24 (app module uses Kotlin stdlib 2.0.21).

### Permissions and intents
`AndroidManifest.xml` already includes:
- Runtime permissions for camera, storage, and location.
- `<queries>` block declaring the implicit intents required by `cordova-plugin-camera` (IMAGE_CAPTURE, GET_CONTENT, PICK, CROP). Keep this section updated if more plugins rely on implicit intents.

### Troubleshooting highlights
- `JAVA_HOME is set to an invalid directory` – export the Temurin 21 path (see Section 3).
- Plugin updates: re-run `npm run build`, `npx cap sync android`, then rebuild. Android Studio may require a Gradle sync afterwards.
- Logging: `adb logcat | grep com.alca.hub`.

## 6. iOS playbook
### Build and run
```bash
cd frontend
LANG=en_US.UTF-8 npx cap sync ios
npx cap open ios   # opens App.xcworkspace
```
Inside Xcode:
1. Open `App.xcworkspace`.
2. Select a simulator or physical device.
3. Cmd+B to build, Cmd+R to run.

### Project defaults
- Minimum iOS target: 14.0 (defined in `Podfile`).
- Pods installed: `Capacitor`, `CapacitorCordova`, generated `CordovaPlugins`.
- `Info.plist` configures `NSCameraUsageDescription`, `NSPhotoLibraryUsageDescription`, `NSLocationWhenInUseUsageDescription`, and `NSLocationAlwaysAndWhenInUseUsageDescription`. Update wording if new permissions are required.

### Troubleshooting highlights
- `xcodebuild requires Xcode` – ensure `sudo xcode-select -s /Applications/Xcode.app/Contents/Developer`.
- Encoding error from CocoaPods (`Unicode Normalization not appropriate`) – run commands with `LANG=en_US.UTF-8`.
- Clean derived data if builds fail unexpectedly:
  ```bash
  rm -rf ~/Library/Developer/Xcode/DerivedData/*
  ```

## 7. Shared Cordova plugins
| Plugin | Version | Native configuration | JS entry point |
|--------|---------|----------------------|----------------|
| `cordova-plugin-camera` | 8.0.0 | Android intents + camera/photo permissions, iOS camera/photo usage keys | `cameraPlugin` in `frontend/src/utils/cordova-plugins.js` |
| `cordova-plugin-geolocation` | 5.0.0 | Location permissions on both platforms | `geolocationPlugin` in the same helper file |

Usage aids:
- `frontend/src/components/CameraTest.jsx` renders manual validation buttons for taking pictures, selecting gallery images, and fetching GPS coordinates.
- The route `/debug/camera` is secured by `ProtectedRoute` and surfaced in the side menu as "Testar Plugins".
- Always wait for the `deviceready` event before calling Cordova APIs; `initPlugins()` in `App.jsx` handles this automatically.

## 8. Tooling and automation
- Vite build: `npm run build`.
- VS Code / Cursor tasks (`.vscode/tasks.json`):
  - Capacitor sync (Android/iOS)
  - Android debug APK build
  - Pod install
  - Open Android Studio or Xcode
- `npx cap doctor` quickly reports dependency mismatches.
- Android Emulator tip: create an API 35 device (`Medium Phone API 36.1` already validated).
- iOS Simulator tip: use `xcrun simctl list` to inspect available runtimes.

## 9. Common development loop
1. Implement or adjust React components in `frontend/src`.
2. `npm run build` to regenerate `dist`.
3. `npx cap sync <platform>` to copy assets and regenerate native configuration.
4. Build/run on the desired platform (Gradle or Xcode).
5. Validate Cordova integration via `/debug/camera` and the feature flow that depends on camera/GPS.

## 10. Known issues and resolutions
- Plugin permissions missing -> Re-sync after editing manifests, then open native IDE to let Gradle/Xcode refresh.
- Pod updates stuck -> Delete `frontend/ios/App/Pods`, rerun `pod install`.
- Android Studio using wrong JDK -> set "Gradle JDK" inside Preferences to Embedded JDK 21 or point to `$JAVA_HOME`.
- Package install conflicts -> prefer `npm install` (lockfile is `package-lock.json`).

## 11. Recommended next steps for new contributors
1. Run `npx cap doctor`, `npx cap run android`, and Xcode builds to confirm the environment.
2. Explore `CameraTest.jsx` and integrate the helper functions into actual product flows (upload workflows, location tracking).
3. Extend this document whenever new plugins or platform-specific configurations are introduced, and cross-link it from `docs/DOCUMENTACAO_INDEX.md`.

